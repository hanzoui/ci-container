# Secrets: Hanzo KMS (kms.hanzo.ai) â€” auth via Hanzo IAM
name: "Update Frontend Container Reference"

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Container version (e.g., 0.0.9)'
        required: true
        type: string

jobs:
  update-frontend:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    steps:
      - name: Fetch secrets from Hanzo KMS
        id: kms
        uses: hanzoui/.github/actions/kms-secrets@main
        with:
          kms_client_id: ${{ secrets.KMS_CLIENT_ID }}
          kms_client_secret: ${{ secrets.KMS_CLIENT_SECRET }}
          secrets: 'FRONTEND_PAT'
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Checkout Hanzo Studio_frontend
        uses: actions/checkout@v4
        with:
          repository: hanzoui/studio_frontend
          token: ${{ steps.kms.outputs.FRONTEND_PAT }}

      - name: Get current version
        id: current
        run: |
          CURRENT=$(grep -oP 'hanzo-studio-ci-container:\K[0-9.]+' .github/workflows/ci-tests-e2e.yaml | head -1 || echo "unknown")
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT

      - name: Update container references
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Update all container references in both workflow files
          sed -i "s|ghcr.io/hanzoui/hanzo-studio-ci-container:[0-9.]*|ghcr.io/hanzoui/hanzo-studio-ci-container:${VERSION}|g" \
            .github/workflows/ci-tests-e2e.yaml \
            .github/workflows/pr-update-playwright-expectations.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.kms.outputs.FRONTEND_PAT }}
          branch: automation/ci-container-${{ steps.version.outputs.version }}
          title: "chore: bump CI container to ${{ steps.version.outputs.version }}"
          body: |
            Updates CI container from `${{ steps.current.outputs.current_version }}` to `${{ steps.version.outputs.version }}`

            **Triggered by:** [Tag ${{ steps.version.outputs.version }}](${{ github.server_url }}/${{ github.repository }}/tree/${{ steps.version.outputs.version }})
          labels: automation
          commit-message: "chore: bump CI container to ${{ steps.version.outputs.version }}"
